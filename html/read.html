<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="icon" href="https://i.imgur.com/XjWCCeV.png" />
  <title>$$book$$</title>
  <meta property="og:title" content="$$chapter$$" />
  <meta property="og:site_name" content="LonelyBall Media" />
  <meta property="og:description" content="$$bookDescription$$" />
  <meta property="og:image" content="$$thumbnail$$" />
  <meta name="theme-color" content="#cbc3e3" />
  <meta name="twitter:card" content="summary_large_image" />
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.1.1/css/all.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet" />
</head>
<style>
      body {  
      background-size: 400% 400%;  
      margin: 0;  
      background-color: #121212;  
      font-family: 'Nunito';  
      font-size: 22px;  
    }  
  
    .flex {  
      display: flex;  
      justify-content: center;  
    }  
  
  .topnav {  
    background-color: #2196F3;  
    overflow: hidden;  
  }  
  
  /* Style the links inside the navigation bar */  
  .topnav a {  
    float: left;  
    display: block;  
    color: #ffffff;  
    text-align: center;  
    padding: 14px 16px;  
    text-decoration: none;  
    font-size: 17px;  
  }  
  
  /* Change the color of links on hover */  
  .topnav a:hover {  
    background-color: #1976D2;  
    color: #ffffff;  
  }  
  
  .topnav a.active {  
    background-color: #1976D2;  
    color: white;  
  }  
  
  /* Hide the link that should open and close the topnav on small screens */  
  .topnav .icon {  
    display: none;  
  }  
  
  @media screen and (max-width: 600px) {  
    .topnav a:not(:first-child) {display: none;}  
    .topnav a.icon {  
      float: right;  
      display: block;  
    }  
  }  
  
  /* The "responsive" class is added to the topnav with JavaScript when the user clicks on the icon. This class makes the topnav look good on small screens (display the links vertically instead of horizontally) */  
  @media screen and (max-width: 600px) {  
    .topnav.responsive {position: relative;}  
    .topnav.responsive a.icon {  
      position: absolute;  
      right: 0;  
      top: 0;  
    }  
    .topnav.responsive a {  
      float: none;  
      display: block;  
      text-align: left;  
    }  
  }  

  .text {
    text-align: center;
  }

  .text-side {
    text-align: left;
  }

.text h1 {  
      color: #2196F3;  
    }  

.text h2 {  
      color: #2196F3;  
    }  
  
    .text p {   
      color: #FFFFFF;  
    }

  .text-novel {
    border-radius: 16px;
    background-color: #2196F3;
    margin-left: 5px;
    margin-right: 5px;
  }

  .slider {
    margin: 10px;
    display: flex;
    flex-wrap: nowrap;
    overflow-x: scroll;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-inline: contain;
  }

  .slider img {
    max-height: 300px;
    margin-right: 5px;
  }

  .slide {
    flex-shrink: 0;
    width: 100%;
    margin-bottom: 5px;
  }

  .slide img {
    max-width: 100%;
  }

  /*Buttons*/

  button {
    text-align: center;
    font-weight: bold;
    text-decoration: none;
    font-family: 'Nunito';
    display: inline-block;
    border-radius: 16px;
    background-color: #2196F3;
    cursor: pointer;
    padding: 10px 24px;
    font-size: 30px;
    color: white;
    margin: auto;
  }

  button:hover {
    background-color: #1976D2;
    transition: 1s;
  }

  .topButtons {
    width: 100%;
    margin: 25px 50px 25px 50px;
  }

  .pnButtons {
    width: 255px;
    margin: 10px;
    text-align: center;
    padding: 5px;
    font-size: 50px;
  }

  /*Buttons End*/

  .comments-container {
    max-width: 700px;
    margin: 0 auto;
  }

  .comment {
    border: 3px solid #1976D2;
    background-color: #2196F3;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 20px;
  }

  .pfp-container {
    float: left;
    margin-right: 15px;
  }

  .pfp {
    border-radius: 50%;
    width: 75px;
    height: 75px;
  }

  .comment-content {
    overflow: hidden;
  }

  .commenter-name {
    margin-top: 0;
    margin-bottom: 10px;
    color: #ffffff;
    font-size: 18px;
  }

  .comment-date {
    display: block;
    margin-bottom: 10px;
    color: #ffffff;
    font-size: 14px;
  }

  .comment-text {
    margin-bottom: 10px;
    color: #ffffff;
    font-size: 16px;
  }

  .spoiler {
    color: black;
    background-color: black;
  }

  .spoiler:hover {
    background-color: white;
  }

  @media screen and (max-width: 600px) {
    .comments-container {
      max-width: 100%;
      padding: 0 20px;
    }

    .comment {
      padding: 20px;
    }

    .pfp-container {
      float: none;
      margin-right: 0;
      margin-bottom: 10px;
      text-align: center;
    }

    .pfp {
      width: 50px;
      height: 50px;
    }
  }


  /*Modal*/
  * {
    box-sizing: border-box;
  }

  .container textarea {
    width: 100%;
    padding: 12px 20px;
    margin: 8px 0;
    display: inline-block;
    box-sizing: border-box;
    background-color: #956a9d;
    border: none;
    color: white;
    outline: none;
    border-radius: 16px;
  }

  .cancelbtn,
  .signupbtn {
    padding: 14px 20px;
  }

  .cancelbtn,
  .signupbtn {
    padding: 14px 20px;
    margin: 8px 0;
    cursor: pointer;
    width: 100%;
    opacity: 0.9;
    float: left;
    width: 50%;
  }

  .cancelbtn:hover,
  .signupbtn:hover {
    opacity: 1;
  }

  .container {
    background-color: #c499cc;
    padding: 16px;
  }

  .container h1,
  p {
    color: white
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: #ffcc99;
    padding-top: 50px;
  }

  .modal-content {
    background-color: #fefefe;
    margin: 5% auto 15% auto;
    border: 1px solid #888;
    width: 80%;
  }

  hr {
    border: 1px solid #f1f1f1;
    margin-bottom: 25px;
  }

  .close {
    position: absolute;
    right: 35px;
    top: 15px;
    font-size: 40px;
    font-weight: bold;
    color: #f1f1f1;
  }

  .close:hover,
  .close:focus {
    color: #f44336;
    cursor: pointer;
  }

  .clearfix::after {
    content: "";
    clear: both;
    display: table;
  }

  @media screen and (max-width: 300px) {

    .cancelbtn,
    .signupbtn {
      width: 100%;
    }
  }

  /*Modal End*/

  /* The alert message box */
  .alert {
    padding: 20px;
    background-color: #f44336;
    color: white;
    margin-bottom: 15px;
    display: none;
  }

  .alert.success {
    background-color: #04AA6D;
  }

  .alert.info {
    background-color: #2196F3;
  }

  .alert.warning {
    background-color: #ff9800;
  }

  .closebtn {
    margin-left: 15px;
    color: white;
    font-weight: bold;
    float: right;
    font-size: 22px;
    line-height: 20px;
    cursor: pointer;
    transition: 0.3s;
  }

  .closebtn:hover {
    color: black;
  }
</style>
<script type="text/javascript">
  async function changeDivContent() {
    const div = document.getElementById("content");
    try {
      let response = await fetch($$data$$);
      let json = await response.json();
      let index = Number("$$previous$$");

      if (json.chapters[index - 1] === undefined) {
        const previousButton = document.getElementById("previousButton");
        previousButton.style.display = "none";
      }
      if (json.chapters[index + 1] === undefined) {
        const nextButton = document.getElementById("nextButton");
        nextButton.style.display = "none";
      }
      const div2 = document.getElementById("credits");
      const div3 = document.getElementById("comments");
      const div4 = document.getElementById("commentstitle");

      function formatString(content) {
        let step1 = content
          .split(" ")
          .join(" ")
          .replaceAll("\n", "</br>")
          .replaceAll("\n\n", "</br></br>");
        let step2 = step1.replaceAll(/\*\*(.*?)\*\*/g, "<b>$1</b>");
        let step3 = step2.replaceAll(/\*(.*?)\*/g, "<em>$1</em>");
        let step4 = step3.replaceAll(/\_(.*?)\_/g, "<ins>$1</ins>");
        return step4;
      }

      if (json.chapters[index].type === "Novel") {
        div.className = 'text';
        let novelContent = json.chapters[index].novel;

        novelContent = formatString(novelContent);

        div.innerHTML = `     
          <h1><b>${json.name}</b></h1>
          <p>${formatString(json.chapters[index].intro)}</p>
          <h2>${json.chapters[index].name}</h2>
          <p>${novelContent}</p>`;
        div2.innerHTML = `	
          <h1>Credits</h1>
          <p>${formatString(json.chapters[index].credits)}</p>
          `;
      } else if (json.chapters[index].type === "Manga") {
        div.className = 'slider snaps-inline';
        console.log(json.chapters[index])
        for (let i = 0; i < json.chapters[index].images.length; i++) {
          const element = json.chapters[index].images[i];
          let img = `https://lonelyballmediacdn-production.up.railway.app/image/${element}`
          div.innerHTML += `<img src="${img}" alt="Page ${i}">`;
        }
      } else if (json.chapters[index].type === "Webtoon") {
        div.className = 'webtoons snaps-inline';
        console.log(json.chapters[index])
        for (let i = 0; i < json.chapters[index].images.length; i++) {
          const element = json.chapters[index].images[i];
          let img = `https://lonelyballmediacdn-production.up.railway.app/image/${element}`
          div.innerHTML += `<div class="slide">
      <img src="${img}" alt="Page ${i}">
    </div>`;
        }
      }

      //Comments
      if (json.chapters[index]?.comments.length === 0) {
        div4.innerHTML = `
            <p>No comments for this chapter</p>`;
      } else {
        for (let i = 0; i < json.chapters[index].comments.length; i++) {
          let chapter = json.chapters[index];
          div3.innerHTML += `<div class="comment">
            <div class="pfp-container">
              <img class="pfp" src="${chapter.comments[i].icon}" alt="Avatar">
              </div>
              <div class="comment-content">
                <h4 class="commenter-name"><a href="/profile/${chapter.comments[i].id}">${chapter.comments[i].username}</a></h4>
                <span class="comment-date">${chapter.comments[i].date}</span>
                <p class="comment-text">${chapter.comments[i].spoiler === true ? `<span class="spoiler"> ${chapter.comments[i].comment} </span>` : chapter.comments[i].comment}</p>
                </div>
                </div>`;
        }
      }
    } catch (err) {
      console.log(err);
      div.className = 'text text-novel';
      div.innerHTML += `<h1>Chapter not found.</h1>`;
    }
  }
</script>

<body onload="changeDivContent()">
    <div class="topnav" id="myTopnav">  
    <a href="/home"><i class="fa-solid fa-house"></i> Home</a>  
    <a href="/explore" class="active"><i class="fa-solid fa-magnifying-glass"></i> Explore</a>  
  
  <a id="account" href="#"><i class="fa-solid fa-user"></i> My Account</a>  
          <a id="toggle" href="#"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out</a>  
  
     <a href="https://cash.app/$PerezDeDios" target="_blank"><i class="fa-solid fa-coins"></i> Donate</a>  
    <a href="javascript:void(0);" class="icon" onclick="myFunction()">  
      <i class="fa-solid fa-bars"></i>  
    </a>  
  </div>  
  
  <script>  
  function myFunction() {  
    var x = document.getElementById("myTopnav");  
    if (x.className === "topnav") {  
      x.className += " responsive";  
    } else {  
      x.className = "topnav";  
    }  
  }  
  </script>  
  
      <script>   
           document.getElementById("toggle").addEventListener("click", async (e) => {  
               if (e.target.innerText === " Sign Out") {   
                   alert("Signing you out!");   
                   localStorage.removeItem("user");   
                   window.location.reload();   
               }   
           });   
       </script>   
  
       <script>   
           if (typeof Storage !== "undefined") {   
               if (localStorage.user) {   
                   let data = JSON.parse(localStorage.user);   
      document.getElementById("account").href = `/profile/${data.id}`;   
               } else {   
      document.getElementById("toggle").innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> Sign In';   
                   document.getElementById("toggle").href = "/access-portal";   
               }   
           } else {   
               document.getElementById("toggle").innerHTML = "<span>&empty;</span>";   
               document.getElementById("account").innerHTML = "<span>&empty;</span>";   
           }   
       </script>

  <div class="flex">
    <button class="topButtons" style="width:auto;" onclick="window.location.href='/explore/$$book$$'"><i class="fa-solid fa-book"></i> Book</button>
    <button class="topButtons" style="width:auto;" onclick="toggleText()">
      Toggle Text
    </button>
  </div>

  <div id="content"></div>

  <div class="flex">
    <button id="previousButton" class="pnButtons" style="width:auto;"
      onclick="window.location.href='/read/$$book$$/$$previous$$'"><i class="fa fa-chevron-circle-left"></i></button>
    <button id="nextButton" class="pnButtons" style="width:auto;"
      onclick="window.location.href='/read/$$book$$/$$next$$'"><i class="fa fa-chevron-circle-right"></i></button>
  </div>

  <div class="text" id="credits"></div>

  <div class="text" id="commentstitle">
    <h1>Comments</h1>
  </div>


  <div class="comments-container" id="comments"></div>

  <div class="flex">
    <button class="topButtons" id="commentButton" style="width:auto;"><i class="fa-solid fa-comment"></i>
      Comment</button>
  </div>

  <script>
    document
      .getElementById("commentButton")
      .addEventListener("click", async (e) => {
        if (!localStorage.user) {
          e.preventDefault();
          error.innerHTML = `<span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
  Sign-In to comment!`;
          error.style.display = "block";
        } else {
          document.getElementById("modal").style.display = "block";
        }
      });
  </script>

  <div id="error" class="alert">
    <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
    Error.
  </div>

  <div id="success" class="alert success">
    <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
    <strong>Success!</strong> Yay.
  </div>

  <div id="modal" class="modal">
    <span onclick="document.getElementById('modal').style.display='none'" class="close"
      title="Close Modal">&times;</span>
    <form class="modal-content" id="commentForm" method="post" action="/comment">
      <div class="container">
        <h1>Comment</h1>
        <p>Please follow the tos while commenting.</p>
        <hr />
        <input id="user" type="hidden" name="user" value="NOTHING" />

        <input type="hidden" name="book" value="$$book$$" />

        <input type="hidden" name="chapter" value="$$chapter$$" />

        <textarea rows="4" cols="50" name="comment" form="commentForm" required></textarea>

        <label>
          <input type="checkbox" name="spoiler" style="margin-bottom:15px"> Spoiler
        </label>

        <div class="clearfix">
          <button type="button" onclick="document.getElementById('modal').style.display='none'" class="cancelbtn">
            Cancel
          </button>
          <button id="submit" type="submit" class="signupbtn">Comment</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    if (typeof Storage !== "undefined") {
      if (localStorage.user) {
        let data = JSON.parse(localStorage.user);
        let userObject = JSON.stringify({ username: data.username, id: data.id, email: data.email, password: data.password })
        document.getElementById("user").value = userObject;
      } else {
        document.getElementById("pbb").style.display = "none";
        document.getElementById("pcb").style.display = "none";
      }
    } else {
      document.getElementById("pbb").style.display = "none";
      document.getElementById("pcb").style.display = "none";
    }
  </script>

  <script>
    const form = document.getElementById("commentForm");
    const error = document.getElementById("error");
    const success = document.getElementById("success");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      document.getElementById("submit").disabled = true;
      const data = Object.fromEntries(new FormData(form).entries());
      const response = await fetch("/comment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ data }),
      });

      if (response.ok) {
        // Display success message here
        const successData = await response.json();
        success.innerHTML = `<span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <strong>Success!</strong> ${successData.success}`;
        success.style.display = "block";
        alert(successData.success)
        document.getElementById("submit").disabled = false;
      } else {
        const errorData = await response.json();
        error.innerHTML = `<span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
  ${errorData.error}`;
        error.style.display = "block";
        alert(errorData.error)
        document.getElementById("submit").disabled = false;
      }
    });
  </script>

  <script>
    var modal = document.getElementById("modal");
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };
  </script>
  <script>
    function toggleText() {
      var element = document.querySelector(".text");
      if (element.style.textAlign === "justify") {
        element.style.textAlign = "center";
      } else {
        element.style.textAlign = "justify";
      }
    }
  </script>
</body>

</html>